{% extends "base.html" %}

{% block title %}Inventario - Sistema de Reservas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-boxes me-2"></i>Gesti√≥n de Inventario</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-success admin-only" id="newArticuloBtn">
                    <i class="fas fa-plus me-1"></i>Nuevo Art√≠culo
                </button>
                <button class="btn btn-outline-secondary" onclick="loadArticulos()">
                    <i class="fas fa-sync me-1"></i>Actualizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estad√≠sticas -->
<div class="row g-3 mb-4" id="inventory-stats">
    <!-- Fila 1: Estad√≠sticas de Art√≠culos -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                <h3 class="mb-0" id="total-articles">0</h3>
                <small>Total Art√≠culos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h3 class="mb-0" id="available-articles">0</h3>
                <small>Art√≠culos Activos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <i class="fas fa-times-circle fa-2x text-warning mb-2"></i>
                <h3 class="mb-0" id="reserved-articles">0</h3>
                <small>Art√≠culos Inactivos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <i class="fas fa-layer-group fa-2x text-info mb-2"></i>
                <h3 class="mb-0" id="total-quantity">0</h3>
                <small>Total Unidades</small>
            </div>
        </div>
    </div>
    
    <!-- Fila 2: Estad√≠sticas de Unidades -->
    <div class="col-md-6">
    <div class="card border-0 shadow-sm card-inventory-success">
            <div class="card-body text-center">
                <i class="fas fa-cube fa-2x text-success mb-2"></i>
                <h3 class="mb-0 text-success fw-bold" id="available-units">0</h3>
                <small class="text-dark fw-bold">Unidades Disponibles para Reservar</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
    <div class="card border-0 shadow-sm card-inventory-warning">
            <div class="card-body text-center">
                <i class="fas fa-calendar-check fa-2x text-warning mb-2"></i>
                <h3 class="mb-0 text-warning fw-bold" id="reserved-units">0</h3>
                <small class="text-dark fw-bold">Unidades Reservadas (Ahora)</small>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Buscar art√≠culos...">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterCategoria">
            <option value="">Todas las categor√≠as</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterDisponibilidad">
            <option value="">Todos los estados</option>
            <option value="true">Disponibles</option>
            <option value="false">No Disponibles</option>
        </select>
    </div>
</div>

<!-- Tabla de Art√≠culos -->
<div class="card border-0 shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th width="80">ID</th>
                        <th>Nombre</th>
                        <th>Descripci√≥n</th>
                        <th>Categor√≠a</th>
                        <th width="100">Cantidad Total</th>
                        <th width="120">Disponibles Ahora</th>
                        <th width="120">Estado</th>
                        <th class="admin-only" width="150">Acciones</th>
                    </tr>
                </thead>
                <tbody id="articulosTableBody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 mb-0 text-muted">Cargando inventario...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Nuevo/Editar Art√≠culo -->
<div class="modal fade" id="articuloModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nuevo Art√≠culo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="articuloForm">
                    <input type="hidden" id="articuloId">
                    <div class="mb-3">
                        <label for="articuloNombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="articuloNombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="articuloDescripcion" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="articuloDescripcion" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="articuloCantidad" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="articuloCantidad" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="articuloCategoria" class="form-label">Categor√≠a</label>
                            <input type="text" class="form-control" id="articuloCategoria">
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="articuloDisponible" checked>
                            <label class="form-check-label" for="articuloDisponible">
                                Disponible para reservas
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveArticulo()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Reservas del Art√≠culo -->
<div class="modal fade" id="reservasModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Reservas del Art√≠culo: <span id="articuloNombre"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reservasContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 mb-0 text-muted">Cargando reservas...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// üîí SEGURIDAD PRE-RENDER: Aplicar clase admin INMEDIATAMENTE
(function() {
    try {
        const userStr = localStorage.getItem('user');
        if (userStr) {
            const user = JSON.parse(userStr);
            if (user && user.is_admin === true) {
                document.body.classList.add('is-admin');
            } else {
                document.body.classList.remove('is-admin');
            }
        } else {
            document.body.classList.remove('is-admin');
        }
    } catch (e) {
        console.error('Error al verificar rol de admin:', e);
        document.body.classList.remove('is-admin');
    }
})();

let articulos = [];
let isAdmin = false;
let articuloModal;
let reservasModal;

document.addEventListener('DOMContentLoaded', function() {
    articuloModal = new bootstrap.Modal(document.getElementById('articuloModal'));
    reservasModal = new bootstrap.Modal(document.getElementById('reservasModal'));
    
    // Event listener para bot√≥n de nuevo art√≠culo
    const newArticuloBtn = document.getElementById('newArticuloBtn');
    if (newArticuloBtn) {
        newArticuloBtn.addEventListener('click', openNewArticuloModal);
    }
    
    setTimeout(() => {
        const user = window.authManager?.getUser();
        if (!user) {
            window.location.href = '/login';
            return;
        }
        
        // Verificar permisos de admin
        if (!user.is_admin) {
            alert('Acceso denegado. Solo los administradores pueden acceder a esta secci√≥n.');
            window.location.href = '/';
            return;
        }
        
        isAdmin = user.is_admin;
        updatePageForAdmin();
        loadArticulos();
    }, 200);
    
    // Event listeners para filtros
    document.getElementById('searchInput').addEventListener('input', filterArticulos);
    document.getElementById('filterCategoria').addEventListener('change', filterArticulos);
    document.getElementById('filterDisponibilidad').addEventListener('change', filterArticulos);
});

function updatePageForAdmin() {
    if (isAdmin) {
        // Mostrar elementos admin-only
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = '';  // Restaurar display por defecto
            el.style.removeProperty('display');  // Remover override
        });
    } else {
        // Ocultar elementos admin-only para usuarios normales
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'none';
        });
    }
}

// Variable global para disponibilidad actual
let disponibilidadActual = {};

// Cargar art√≠culos
async function loadArticulos() {
    try {
        const response = await axios.get('/api/v1/articulos/');
        articulos = response.data;
        await loadEstadisticas(); // Cargar estad√≠sticas reales
        await loadDisponibilidadActual(); // Cargar disponibilidad actual
        updateCategoriasFilter(articulos);
        renderArticulos(articulos);
    } catch (error) {
        console.error('Error cargando art√≠culos:', error);
        showError('Error al cargar el inventario');
    }
}

// Cargar disponibilidad actual de todos los art√≠culos
async function loadDisponibilidadActual() {
    try {
        const response = await axios.get('/api/v1/articulos/disponibilidad/actual');
        disponibilidadActual = response.data;
    } catch (error) {
        console.error('Error cargando disponibilidad actual:', error);
        disponibilidadActual = {};
    }
}

// Cargar estad√≠sticas del inventario
async function loadEstadisticas() {
    try {
        const response = await axios.get('/api/v1/articulos/estadisticas/inventario');
        const stats = response.data;
        
        // Tarjetas de art√≠culos (tipos)
        document.getElementById('total-articles').textContent = stats.total_articulos;
        document.getElementById('available-articles').textContent = stats.articulos_disponibles;
        document.getElementById('reserved-articles').textContent = stats.articulos_no_disponibles;
        document.getElementById('total-quantity').textContent = stats.total_unidades;
        
        // Tarjetas de unidades (cantidad real disponible/reservada)
        document.getElementById('available-units').textContent = stats.unidades_disponibles;
        document.getElementById('reserved-units').textContent = stats.unidades_reservadas;
        
    } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
        // Si falla, usar el m√©todo antiguo como fallback
        updateStatsLegacy(articulos);
    }
}

// M√©todo legacy para estad√≠sticas (fallback)
function updateStatsLegacy(data) {
    const total = data.length;
    const disponibles = data.filter(a => a.disponible).length;
    const noDisponibles = total - disponibles;
    const cantidadTotal = data.reduce((sum, a) => sum + (a.cantidad || 0), 0);
    
    document.getElementById('total-articles').textContent = total;
    document.getElementById('available-articles').textContent = disponibles;
    document.getElementById('reserved-articles').textContent = noDisponibles;
    document.getElementById('total-quantity').textContent = cantidadTotal;
}

// DEPRECATED: Mantener por compatibilidad pero ya no se usa
function updateStats(data) {
    updateStatsLegacy(data);
}

// Actualizar filtro de categor√≠as
function updateCategoriasFilter(data) {
    const categorias = [...new Set(data.map(a => a.categoria).filter(c => c))];
    const select = document.getElementById('filterCategoria');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">Todas las categor√≠as</option>';
    categorias.forEach(cat => {
        select.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
    
    select.value = currentValue;
}

// Renderizar art√≠culos
function renderArticulos(data) {
    const tbody = document.getElementById('articulosTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-boxes fa-2x text-muted mb-2"></i>
                    <p class="mb-0 text-muted">No se encontraron art√≠culos</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = data.map(articulo => {
        const disp = disponibilidadActual[articulo.id] || { disponibles: articulo.cantidad, reservadas: 0 };
        const disponiblesAhora = disp.disponibles;
        const reservadas = disp.reservadas;
        const porcentajeDisponible = articulo.cantidad > 0 ? (disponiblesAhora / articulo.cantidad) * 100 : 0;
        
        // Determinar color seg√∫n disponibilidad
        let colorDisponible = 'bg-success';
        if (disponiblesAhora === 0) {
            colorDisponible = 'bg-danger';
        } else if (porcentajeDisponible < 50) {
            colorDisponible = 'bg-warning';
        }
        
        return `
        <tr>
            <td><span class="badge bg-secondary">#${articulo.id}</span></td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-box text-primary me-2"></i>
                    <strong>${articulo.nombre}</strong>
                </div>
            </td>
            <td><small class="text-muted">${articulo.descripcion || '-'}</small></td>
            <td>
                ${articulo.categoria ? `<span class="badge bg-info">${articulo.categoria}</span>` : '-'}
            </td>
            <td class="text-center">
                <span class="badge bg-primary">${articulo.cantidad || 0}</span>
            </td>
            <td class="text-center">
                <span class="badge ${colorDisponible}" title="${reservadas > 0 ? reservadas + ' reservadas ahora' : 'Ninguna reservada'}">
                    <i class="fas fa-cube me-1"></i>
                    ${disponiblesAhora} / ${articulo.cantidad}
                </span>
            </td>
            <td>
                <span class="badge ${articulo.disponible ? 'bg-success' : 'bg-warning'}">
                    <i class="fas fa-${articulo.disponible ? 'check' : 'times'} me-1"></i>
                    ${articulo.disponible ? 'Disponible' : 'No Disponible'}
                </span>
            </td>
            ${isAdmin ? `
                <td>
                    <div class="d-flex gap-2 btn-equal-group">
                        <button class="btn btn-sm btn-outline-info btn-3d flex-fill w-100 py-2" onclick="verReservas(${articulo.id})" aria-label="Ver Reservas" title="Ver Reservas">
                            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                            <span class="visually-hidden">Ver Reservas</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary btn-3d flex-fill w-100 py-2" onclick="editArticulo(${articulo.id})" aria-label="Editar" title="Editar">
                            <i class="fas fa-edit" aria-hidden="true"></i>
                            <span class="visually-hidden">Editar</span>
                        </button>
                        <button class="btn btn-sm btn-outline-${articulo.disponible ? 'warning' : 'success'} btn-3d flex-fill w-100 py-2" 
                                onclick="toggleDisponibilidad(${articulo.id})" 
                                aria-label="${articulo.disponible ? 'Marcar No Disponible' : 'Marcar Disponible'}" title="${articulo.disponible ? 'Marcar No Disponible' : 'Marcar Disponible'}">
                            <i class="fas fa-${articulo.disponible ? 'times' : 'check'}" aria-hidden="true"></i>
                            <span class="visually-hidden">${articulo.disponible ? 'Marcar No Disponible' : 'Marcar Disponible'}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-3d flex-fill w-100 py-2" onclick="deleteArticulo(${articulo.id})" aria-label="Eliminar" title="Eliminar">
                            <i class="fas fa-trash" aria-hidden="true"></i>
                            <span class="visually-hidden">Eliminar</span>
                        </button>
                    </div>
                </td>
            ` : ''}
        </tr>
    `}).join('');
}

// Filtrar art√≠culos
function filterArticulos() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoriaFilter = document.getElementById('filterCategoria').value;
    const disponibilidadFilter = document.getElementById('filterDisponibilidad').value;
    
    let filtered = articulos.filter(articulo => {
        const matchSearch = articulo.nombre.toLowerCase().includes(searchTerm) ||
                          (articulo.descripcion && articulo.descripcion.toLowerCase().includes(searchTerm));
        
        const matchCategoria = !categoriaFilter || articulo.categoria === categoriaFilter;
        
        const matchDisponibilidad = !disponibilidadFilter || 
                                   articulo.disponible.toString() === disponibilidadFilter;
        
        return matchSearch && matchCategoria && matchDisponibilidad;
    });
    
    renderArticulos(filtered);
}

// Abrir modal para nuevo art√≠culo
function openNewArticuloModal() {
    document.getElementById('articuloForm').reset();
    document.getElementById('articuloId').value = '';
    document.getElementById('modalTitle').textContent = 'Nuevo Art√≠culo';
    document.getElementById('articuloDisponible').checked = true;
    articuloModal.show();
}

// Editar art√≠culo
async function editArticulo(id) {
    try {
        const response = await axios.get(`/api/v1/articulos/${id}`);
        const articulo = response.data;
        
        document.getElementById('articuloId').value = articulo.id;
        document.getElementById('articuloNombre').value = articulo.nombre;
        document.getElementById('articuloDescripcion').value = articulo.descripcion || '';
        document.getElementById('articuloCantidad').value = articulo.cantidad || 0;
        document.getElementById('articuloCategoria').value = articulo.categoria || '';
        document.getElementById('articuloDisponible').checked = articulo.disponible;
        document.getElementById('modalTitle').textContent = 'Editar Art√≠culo';
        
        articuloModal.show();
    } catch (error) {
        console.error('Error al cargar art√≠culo:', error);
        showError('Error al cargar el art√≠culo');
    }
}

// Guardar art√≠culo
async function saveArticulo() {
    const form = document.getElementById('articuloForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const id = document.getElementById('articuloId').value;
    const cantidadValue = document.getElementById('articuloCantidad').value;
    const descripcionValue = document.getElementById('articuloDescripcion').value.trim();
    
    const data = {
        nombre: document.getElementById('articuloNombre').value,
        descripcion: descripcionValue || null,
        cantidad: cantidadValue ? parseInt(cantidadValue) : 1,
        categoria: document.getElementById('articuloCategoria').value || null,
        disponible: document.getElementById('articuloDisponible').checked
    };
    
    try {
        if (id) {
            await axios.put(`/api/v1/articulos/${id}`, data);
            showSuccess('Art√≠culo actualizado exitosamente');
        } else {
            await axios.post('/api/v1/articulos/', data);
            showSuccess('Art√≠culo creado exitosamente');
        }
        
        articuloModal.hide();
        loadArticulos();
    } catch (error) {
        console.error('Error al guardar art√≠culo:', error);
        showError(error.response?.data?.detail || 'Error al guardar el art√≠culo');
    }
}

// Toggle disponibilidad
async function toggleDisponibilidad(id) {
    try {
        const articulo = articulos.find(a => a.id === id);
        if (!articulo) return;
        
        await axios.put(`/api/v1/articulos/${id}`, {
            ...articulo,
            disponible: !articulo.disponible
        });
        
        showSuccess('Estado actualizado exitosamente');
        loadArticulos();
    } catch (error) {
        console.error('Error al cambiar disponibilidad:', error);
        showError('Error al cambiar el estado del art√≠culo');
    }
}

// Eliminar art√≠culo
async function deleteArticulo(id) {
    if (!confirm('¬øEst√° seguro de eliminar este art√≠culo?')) return;
    
    try {
        await axios.delete(`/api/v1/articulos/${id}`);
        showSuccess('Art√≠culo eliminado exitosamente');
        loadArticulos();
    } catch (error) {
        console.error('Error al eliminar art√≠culo:', error);
        showError(error.response?.data?.detail || 'Error al eliminar el art√≠culo');
    }
}

// Ver reservas del art√≠culo
async function verReservas(articuloId) {
    const articulo = articulos.find(a => a.id === articuloId);
    if (!articulo) return;
    
    document.getElementById('articuloNombre').textContent = articulo.nombre;
    reservasModal.show();
    
    const content = document.getElementById('reservasContent');
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 mb-0 text-muted">Cargando reservas...</p>
        </div>
    `;
    
    try {
        const response = await axios.get(`/api/v1/articulos/${articuloId}/reservas`);
        const reservas = response.data;
        
        if (reservas.length === 0) {
            content.innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Este art√≠culo no tiene reservas activas ni futuras.
                </div>
            `;
            return;
        }
        
        content.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Reserva</th>
                            <th>Estado</th>
                            <th>Tipo</th>
                            <th>Persona</th>
                            <th>Sala</th>
                            <th>Cantidad</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reservas.map(r => {
                            const ahora = new Date();
                            const inicio = new Date(r.fecha_hora_inicio);
                            const fin = new Date(r.fecha_hora_fin);
                            const esActiva = inicio <= ahora && fin >= ahora;
                            const esFutura = inicio > ahora;
                            const estadoBadge = esActiva 
                                ? '<span class="badge bg-success"><i class="fas fa-circle me-1"></i>Activa</span>' 
                                : '<span class="badge bg-info"><i class="fas fa-clock me-1"></i>Futura</span>';
                            
                            return `
                            <tr class="${esActiva ? 'table-success' : ''}">
                                <td><span class="badge bg-secondary">#${r.id}</span></td>
                                <td>${estadoBadge}</td>
                                <td>
                                    <span class="badge ${r.tipo === 'Reserva de Sala' ? 'bg-primary' : 'bg-info'}">
                                        <i class="fas fa-${r.tipo === 'Reserva de Sala' ? 'door-closed' : 'box'} me-1"></i>
                                        ${r.tipo === 'Reserva de Sala' ? 'Sala' : 'Directa'}
                                    </span>
                                </td>
                                <td>${r.persona_nombre}</td>
                                <td>${r.sala_nombre || '-'}</td>
                                <td><span class="badge bg-primary">${r.cantidad || 1}</span></td>
                                <td>${formatDateTime(r.fecha_hora_inicio)}</td>
                                <td>${formatDateTime(r.fecha_hora_fin)}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('Error al cargar reservas:', error);
        content.innerHTML = `
            <div class="alert alert-danger mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error al cargar las reservas del art√≠culo.
            </div>
        `;
    }
}

// Formatear fecha y hora
function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Mostrar mensajes con Toast
function showSuccess(message) {
    showToast('‚úÖ ' + message, 'success');
}

function showError(message) {
    // Si el mensaje es un objeto, extraer el texto apropiado
    if (typeof message === 'object') {
        if (message.detail) {
            message = message.detail;
        } else if (message.message) {
            message = message.message;
        } else {
            message = JSON.stringify(message);
        }
    }
    showToast('‚ùå ' + message, 'danger');
}

// Funci√≥n para mostrar Toast notifications
function showToast(message, type = 'success') {
    // Crear contenedor si no existe
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Determinar el tipo de alerta de Bootstrap
    const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-info';
    
    // Crear el toast
    const toastId = 'toast_' + Date.now();
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    // Mostrar el toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 3000 // 3 segundos
    });
    toast.show();
    
    // Remover del DOM despu√©s de ocultarse
    toastElement.addEventListener('hidden.bs.toast', function () {
        toastElement.remove();
    });
}
</script>
{% endblock %}

