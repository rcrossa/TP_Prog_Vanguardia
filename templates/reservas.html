{% extends "base.html" %}

{% block title %}Sistema de Reservas - Sistema de Reservas{% endblock %}

{% block styles %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-calendar-check me-2"></i>Sistema de Reservas</h1>
            <button class="btn btn-primary" id="newReservaBtn">
                <i class="fas fa-calendar-plus me-1"></i>Nueva Reserva
            </button>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Buscar reservas...">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterTipo">
            <option value="">Todos los tipos</option>
            <option value="sala">Reservas de Salas</option>
            <option value="articulo">Reservas de Artículos</option>
        </select>
    </div>
    <div class="col-md-2">
        <select class="form-select" id="filterEstado">
            <option value="">Todos los estados</option>
            <option value="futuro">Futuras</option>
            <option value="pasado">Pasadas</option>
            <option value="activo">Activas</option>
        </select>
    </div>
    <div class="col-md-3">
        <button class="btn btn-outline-secondary w-100" onclick="loadReservas()">
            <i class="fas fa-sync me-1"></i>Actualizar
        </button>
    </div>
</div>

<!-- Tabla de Reservas -->
<div class="card border-0 shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th width="80">ID</th>
                        <th>Tipo</th>
                        <th>Recurso</th>
                        <th>Persona</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>Estado</th>
                        <th width="150">Acciones</th>
                    </tr>
                </thead>
                <tbody id="reservasTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 mb-0 text-muted">Cargando reservas...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Nueva/Editar Reserva -->
<div class="modal fade" id="reservaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nueva Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reservaForm">
                    <input type="hidden" id="reservaId">
                    
                    <!-- Tipo de Reserva -->
                    <div class="mb-3">
                        <label class="form-label">Tipo de Reserva</label>
                        <select class="form-select" id="tipoReserva" required>
                            <option value="">Seleccione...</option>
                            <option value="sala">Sala</option>
                            <option value="articulo">Artículo</option>
                        </select>
                    </div>
                    
                    <!-- Sala (solo si tipo = sala) -->
                    <div class="mb-3" id="salaGroup">
                        <label class="form-label">Sala</label>
                        <select class="form-select" id="idSala">
                            <option value="">Cargando salas...</option>
                        </select>
                    </div>
                    
                    <!-- Artículo (solo si tipo = articulo) -->
                    <div class="mb-3" id="articuloGroup">
                        <label class="form-label">Artículo</label>
                        <select class="form-select" id="idArticulo">
                            <option value="">Cargando artículos...</option>
                        </select>
                    </div>
                    
                    <!-- Persona -->
                    <div class="mb-3">
                        <label class="form-label">Persona</label>
                        <select class="form-select" id="idPersona" required>
                            <option value="">Cargando personas...</option>
                        </select>
                    </div>
                    
                    <!-- Fechas -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha/Hora Inicio</label>
                            <input type="datetime-local" class="form-control" id="fechaInicio" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha/Hora Fin</label>
                            <input type="datetime-local" class="form-control" id="fechaFin" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveReserva()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gestionar Artículos de Reserva -->
<div class="modal fade" id="articulosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-boxes me-2"></i>Gestionar Artículos de la Reserva
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reservaIdArticulos">
                
                <!-- Artículos ya asignados -->
                <div class="mb-4">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-check-circle me-1"></i>Artículos Asignados
                    </h6>
                    <div id="articulosAsignados">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <!-- Artículos disponibles para agregar -->
                <div>
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-plus-circle me-1"></i>Agregar Artículos
                    </h6>
                    <div class="alert alert-info mb-3 alert-sm">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nota:</strong> Use los botones <strong>+ / -</strong> en la lista de arriba para ajustar cantidades de artículos ya asignados.
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Artículo</label>
                            <select class="form-select" id="articuloSelect" onchange="actualizarInfoArticulo()">
                                <option value="">Seleccione un artículo...</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="articuloCantidad" min="1" value="1" placeholder="Cant.">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-success w-100" onclick="agregarArticuloAReserva()" id="btnAgregarArticulo">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Eliminar Artículo -->
<div class="modal fade" id="confirmDeleteArticuloModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h6 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-box-open fa-3x text-danger mb-3"></i>
                    <h6>¿Eliminar artículo de la reserva?</h6>
                </div>
                <p class="text-center mb-2">
                    Se eliminará <strong id="articuloNameToDelete"></strong> de esta reserva.
                </p>
                <p class="text-muted small text-center mb-0">
                    El artículo volverá a estar disponible para otras reservas.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmarEliminarArticulo()">
                    <i class="fas fa-trash me-1"></i>Eliminar Artículo
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="/static/js/reservas/reservas.js"></script>
{% endblock %}